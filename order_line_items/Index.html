<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { --primary: #2e7d32; --bg: #f4f7f6; }
    body { background: var(--bg); font-family: 'Segoe UI', sans-serif; }
    .hidden { display: none; }
    .item-card { background: white; border-radius: 10px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .item-img { height: 120px; object-fit: cover; border-radius: 8px 8px 0 0; background: #eee; }
    .loader { width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="container py-4">
  <div id="login-section" class="card shadow mx-auto" style="max-width: 400px;">
    <div class="card-header bg-success text-white text-center"><h5>Grocery Shop Login</h5></div>
    <div class="card-body p-4">
      <div class="mb-3"><label>Varga</label><select id="varga" class="form-select" onchange="fetchNames()"></select></div>
      <div class="mb-3"><label>Name</label><select id="name" class="form-select"></select></div>
      <div class="mb-3"><label>Mobile</label><input type="tel" id="mobile" class="form-control" placeholder="10 Digit Mobile"></div>
      <button id="login-btn" class="btn btn-success w-100" onclick="doLogin()">Login to Start</button>
    </div>
  </div>

  <div id="shop-section" class="hidden">
    <div class="row">
      <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
          <h5 id="welcome-msg" class="text-success mb-0"></h5>
          <select id="cat-filter" class="form-select w-auto" onchange="filterProducts()"><option value="All">All Categories</option></select>
        </div>
        <div id="inventory-grid" class="row g-3"></div>
      </div>
      <div class="col-lg-3">
        <div id="cart-sidebar" class="bg-white p-3 rounded shadow-sm">
          <h6><i class="material-icons align-middle">shopping_cart</i> Your Cart</h6><hr>
          <div id="cart-list" class="mb-3 small">Empty</div>
          <div class="h6 d-flex justify-content-between"><strong>Total:</strong><strong id="total-val">₹0</strong></div>
          <button id="place-order-btn" class="btn btn-success w-100 mt-3 disabled" onclick="placeOrder()">Place Order</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentUser = null, fullInventory = [], cart = [];
  let currentOrderId = "";

  function generateOrderId() { currentOrderId = "ORD-" + Date.now(); }

  window.onload = () => {
    generateOrderId();
    google.script.run.withSuccessHandler(vargas => {
      const v = document.getElementById('varga');
      v.innerHTML = '<option value="">Select Varga</option>';
      vargas.forEach(item => v.add(new Option(item, item)));
    }).getVargas();
  };

  function fetchNames() {
    const v = document.getElementById('varga').value;
    google.script.run.withSuccessHandler(names => {
      const n = document.getElementById('name');
      n.innerHTML = '<option value="">Select Name</option>';
      names.forEach(item => n.add(new Option(item, item)));
    }).getNamesByVarga(v);
  }

  function doLogin() {
    const v = document.getElementById('varga').value, n = document.getElementById('name').value, m = document.getElementById('mobile').value;
    if(!v || !n || !m) return alert("All fields required");
    
    // Purge cart on login attempt
    cart = []; 
    
    document.getElementById('login-btn').innerHTML = '<span class="loader"></span> Validating...';
    google.script.run.withSuccessHandler(res => {
      if(res.success) { 
        currentUser = res; 
        updateCartUI(); 
        startShop(); 
      } 
      else { 
        alert("Login Failed."); 
        document.getElementById('login-btn').innerText = "Login to Start"; 
      }
    }).validateLogin(v, n, m);
  }

  function startShop() {
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('shop-section').classList.remove('hidden');
    document.getElementById('welcome-msg').innerText = "Namaste, " + currentUser.name;

    google.script.run.withSuccessHandler(data => {
      fullInventory = data;
      
      // Load Categories from data
      const catFilter = document.getElementById('cat-filter');
      catFilter.innerHTML = '<option value="All">All Categories</option>';
      const uniqueCats = [...new Set(data.map(i => i.category))].filter(c => c).sort();
      uniqueCats.forEach(c => catFilter.add(new Option(c, c)));
      
      renderInventory(data);
    }).getInventoryData();
  }

  function renderInventory(items) {
    const grid = document.getElementById('inventory-grid');
    grid.innerHTML = items.map(item => `
      <div class="col-6 col-md-4 col-xl-3">
        <div class="item-card p-2 h-100 text-center">
          <img src="${item.imageUrl}" class="item-img w-100 mb-2" onerror="this.src='https://via.placeholder.com/150'">
          <div class="small fw-bold text-truncate">${item.itemName}</div>
          <div class="text-success small">₹${item.salePrice} / ${item.uom}</div>
          <input type="number" id="qty-${item.itemId}" class="form-control form-control-sm my-2" value="1" min="0.1" step="0.5">
          <button class="btn btn-sm btn-outline-success w-100" onclick="addToCart('${item.itemId}')">Add</button>
        </div>
      </div>
    `).join('');
  }

  function addToCart(id) {
    const item = fullInventory.find(i => i.itemId === id);
    const qty = parseFloat(document.getElementById('qty-' + id).value);
    if(isNaN(qty) || qty <= 0) return;
    
    const disc = (1 - (currentUser.discount/100));
    cart.push({ ...item, quantity: qty, subtotal: (qty * item.salePrice * disc).toFixed(2) });
    updateCartUI();
  }

  function updateCartUI() {
    const list = document.getElementById('cart-list'), btn = document.getElementById('place-order-btn');
    let total = 0;
    
    if (cart.length === 0) {
      list.innerHTML = "Empty";
      document.getElementById('total-val').innerText = "₹0";
      btn.classList.add('disabled');
      return;
    }

    list.innerHTML = cart.map(i => {
      total += parseFloat(i.subtotal);
      return `<div class="cart-item d-flex justify-content-between"><span>${i.itemName}</span><span>₹${i.subtotal}</span></div>`;
    }).join('');
    
    document.getElementById('total-val').innerText = "₹" + total.toFixed(2);
    btn.classList.remove('disabled');
  }

  function hardReset() {
    cart = []; currentUser = null; generateOrderId();
    const btn = document.getElementById('place-order-btn');
    btn.disabled = false; btn.innerHTML = "Place Order"; btn.classList.add('disabled');
    document.getElementById('login-btn').innerText = "Login to Start";
    document.getElementById('mobile').value = "";
    updateCartUI();
    document.getElementById('shop-section').classList.add('hidden');
    document.getElementById('login-section').classList.remove('hidden');
  }

  function placeOrder() {
    const btn = document.getElementById('place-order-btn');
    btn.disabled = true; btn.innerHTML = '<span class="loader"></span> Saving...';
    
    google.script.run.withSuccessHandler(res => {
      if(res === true) { 
        alert("Order Successful!"); 
        hardReset(); 
      } 
      else { 
        alert(res); 
        btn.disabled = false; btn.innerHTML = "Place Order"; 
      }
    }).finalizeOrderBulk({ 
        orderId: currentOrderId, 
        customerId: currentUser.id, 
        customerName: currentUser.name, 
        total: document.getElementById('total-val').innerText.replace('₹','') 
    }, cart);
  }

  function filterProducts() {
    const cat = document.getElementById('cat-filter').value;
    renderInventory(cat === "All" ? fullInventory : fullInventory.filter(i => i.category === cat));
  }
</script>
</body>
</html>