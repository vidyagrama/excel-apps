<!DOCTYPE html>
<html>

<head>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root {
      --vg-brown: #634121;
      --vg-amber: #E89F22;
      --vg-cream: #FAF9F6;
      --success-green: #2e7d32;
      --border-light: #e0d7c6;
      --danger-red: #dc3545;
    }

    body,
    input,
    textarea,
    button,
    select {
      font-family: Verdana, Geneva, sans-serif;
    }

    body {
      padding: 15px;
      background-color: var(--vg-cream);
      display: flex;
      justify-content: center;
    }

    .main-layout {
      display: flex;
      gap: 20px;
      width: 100%;
      max-width: 1100px;
      align-items: flex-start;
    }

    .container {
      flex: 2;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(99, 65, 33, 0.1);
      border: 1px solid var(--border-light);
    }

    .sidebar {
      flex: 1.2;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(99, 65, 33, 0.1);
      border: 1px solid var(--border-light);
      max-height: 90vh;
      overflow-y: auto;
    }

    h2,
    h3 {
      color: var(--vg-brown);
      margin-top: 0;
      border-bottom: 2px solid var(--vg-amber);
      padding-bottom: 10px;
    }

    h2 {
      text-align: center;
      font-size: 1.2rem;
    }

    h3 {
      font-size: 1rem;
      text-align: left;
    }

    #scanner-wrapper {
      display: none;
      margin-bottom: 15px;
      border: 2px solid var(--vg-amber);
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }

    #reader {
      width: 100%;
    }

    .search-box,
    .sidebar-header {
      margin-bottom: 20px;
      padding: 10px;
      background: #f3efea;
      border-radius: 8px;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: var(--vg-brown);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s ease;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .scan-btn {
      background-color: var(--vg-amber);
      width: auto;
    }

    .search-btn {
      background-color: var(--vg-brown);
      width: auto;
    }

    .reset-btn {
      background-color: #757575;
      width: auto;
    }

    .refresh-btn {
      background: white;
      border: 1px solid var(--border-light);
      color: var(--vg-brown);
      padding: 8px 12px;
      width: auto;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Container to allow horizontal scroll if columns are too wide */
    .sidebar-table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .item-list-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    /* Added: Make rows interactive */
    .item-list-table tbody tr {
      cursor: pointer; /* Changes mouse to 'hand' icon */
      transition: background-color 0.2s ease; /* Smooth hover transition */
    }

    /* Added: Highlight row on hover */
    .item-list-table tbody tr:hover {
      background-color: #f8f9fa; /* Light grey highlight */
    }

    /* Added: Stronger highlight for active/clicked row */
    .item-list-table tbody tr:active {
      background-color: #e8f0fe;
    }

    .item-list-table th, 
    .item-list-table td {
      padding: 8px 4px;
      text-align: left;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }

    /* Specific column control */
    .item-list-table th:nth-child(2), 
    .item-list-table td:nth-child(2) {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* If a row has low stock, give it a subtle red tint on hover */
    .item-list-table tbody tr.low-stock-row:hover {
      background-color: #fff0f0;
    }

    #status-bar {
      display: none;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 13px;
      font-weight: bold;
    }

    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .field {
      margin-bottom: 10px;
    }

    .full-width {
      grid-column: span 2;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
      color: var(--vg-brown);
      font-size: 11px;
    }

    /* Low Stock Visual */
    .low-stock-row {
      background-color: #fff4f4 !important;
    }

    .warning-icon {
      color: var(--danger-red);
      font-weight: bold;
      margin-left: 4px;
    }

    @media (max-width: 850px) {
      .main-layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        max-height: none;
      }

      .grid-container {
        grid-template-columns: 1fr;
      }

      .full-width {
        grid-column: span 1;
      }
    }

    #customModal {
      transition: opacity 0.3s ease;
    }

    .modal-content {
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>

  <div class="main-layout">
    <div class="container">
      <h2>Vidyagrama Inventory Manager</h2>
      <div id="status-bar"></div>

      <div id="scanner-wrapper">
        <div id="reader"></div>
        <button type="button" onclick="stopScanner()" style="background:#f44336; border-radius:0;">Close Camera</button>
      </div>

      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Scan or Enter SKU..." onkeypress="handleSearchKeyPress(event)">
        <button type="button" class="scan-btn" onclick="startScanner()">üì∏</button>
        <button type="button" class="search-btn" id="mainSearchBtn" onclick="findItem()">Search</button>
        <button type="button" class="reset-btn" onclick="clearFormToDefault(true)">Reset</button>
      </div>

      <form id="entryForm">
        <input type="hidden" id="rowNumber" name="rowNumber">
        <input type="hidden" id="slNo" name="slNo">
        <div class="grid-container">
          <div class="field">
            <label>Main Category</label>
            <select name="mainCategory" id="mainCategory" onchange="updateSubCategories(); loadRecentItems();" required>
              <option value="dhanyam">dhanyam</option>
              <option value="varnam">varnam</option>
              <option value="vastram">vastram</option>
              <option value="gavya">gavya</option>
              <option value="soaps">soaps</option>
            </select>
          </div>

          <div class="field">
            <label>Sub Category</label>
            <select name="category" id="subCategory" required></select>
          </div>

          <div class="field full-width"><label>Item Name</label><input type="text" name="itemName" required></div>

          <div class="field">
            <label>Unit of Measure</label>
            <select name="uom">
                <option value="kilogram (kg)">kilogram (kg)</option>
                <option value="grams (gms)">grams (gms)</option>
                <option value="liter (ltr)">liter (ltr)</option>
                <option value="meter (mtr)">meter (mtr)</option>
                <option value="piece (pc)">piece (pc)</option>
                <option value="box (Bx)">box (Bx)</option>
                <option value="bottle (Btl)">bottle (Btl)</option>
                <option value="tin (tin)">tin (tin)</option>
                <option value="No's">No's</option>
            </select>
          </div>
          <div class="field">
            <label>Status</label>
            <select name="status">
                <option value="In stock">In stock</option>
                <option value="Temporarily unavailable">Temporarily unavailable</option>
                <option value="Repurchase needed">Repurchase needed</option>
                <option value="Sold out">Sold out</option>
            </select>
          </div>
          <div class="field"><label>Purchase Price</label><input type="number" step="0.01" name="purchasePrice" id="pPrice" required oninput="calculateAutoFields()">
          </div>
          <div class="field"><label>Markup %</label><input type="number" step="0.1" name="priceMarkupPercentage" id="markup" value="20" oninput="calculateAutoFields()">
          </div>
          <div class="field"><label>Sale Price (Auto)</label><input type="number" step="0.01" name="salePrice" id="sPrice" readonly>
          </div>
          <div class="field"><label>Current Stock</label><input type="number" name="stock" id="stockInput" required oninput="calculateAutoFields()">
          </div>
          <div class="field"><label>Stock Value (Auto)</label><input type="number" step="0.01" name="stockValue" id="valOutput" readonly>
          </div>
          <div class="field"><label>Reorder Point</label><input type="number" name="reorderPoint" value="5"></div>
          <div class="field"><label>Min Order Qty (MOQ)</label><input type="number" name="moq" value="1" step="any">
          </div>
          <div class="field"><label>Mfg Date</label><input type="date" name="mfgDate"></div>
          <div class="field"><label>Expiry Date</label><input type="date" name="expiryDate"></div>

          <div class="field full-width" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label>Vendor</label>
              <select name="vendorID" id="vendorSelect" onchange="autoGenerateSKU()">
                <option value="">Loading vendors...</option>
              </select>
            </div>
            <div>
              <label>SKU / Barcode</label>
              <div style="display: flex; gap: 5px;">
                <input type="text" name="sku" id="skuField" oninput="validateSkuLive()" placeholder="Auto-gen">
              </div>
            </div>
          </div>

          <div class="field full-width" style="border-top: 1px solid #eee; padding-top: 15px;">
            <label>Product Image</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="hidden" name="image_url" id="image_url_hidden">
              <input type="hidden" name="delete_url" id="delete_url_hidden">
              <input type="file" id="imageFileSelector" accept="image/*" style="flex-grow: 1;" onchange="clearImageWarning()" ...>
              <button type="button" onclick="uploadToImgBB()" id="uploadBtn" style="width: 100px; background: #2196F3;">Upload</button>
              <button type="button" onclick="handleImageDeletion()" id="deleteBtn" style="width: 100px; background: var(--danger-red); display: none;">Remove</button>
            </div>
            <div id="imagePreviewContainer" style="margin-top: 10px; display: none;">
              <img id="imgPreview" src="" style="max-width: 120px; border-radius: 8px; border: 1px solid #ddd;">
            </div>
          </div>
        </div>

        <div class="field full-width" style="display: flex; gap: 10px; margin-top: 15px;">
          <button type="submit" id="submitBtn" style="flex: 2;">Add to Inventory</button>
          <button type="button" id="deleteInventoryBtn" onclick="handleInventoryDelete()" 
                  style="flex: 1; background: var(--danger-red); display: none;">Delete Item</button>
        </div>

      </form>
    </div>

    <div class="sidebar">
      <h3>Inventory Items</h3>
      <div class="sidebar-header">
        <input type="text" id="listFilter" placeholder="Filter list..." onkeyup="filterSidebarList()">
        <button type="button" onclick="loadRecentItems()" class="refresh-btn">‚Üª</button>
      </div>
      
      <div class="table-wrapper">
        <table class="item-list-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th style="text-align:center;">Img</th>
              <th>SKU</th>
              <th>Stock</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="recentItemsBody">
            <tr>
              <td colspan="6" style="text-align:center;">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>

    <div id="customModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
      <div class="modal-content" style="background:white; padding:30px; border-radius:15px; max-width:320px; width:90%; text-align:center; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
        <div id="modalIcon" style="font-size: 40px; margin-bottom: 10px;">üóëÔ∏è</div>
        <h3 id="modalTitle" style="border:none; color:var(--vg-brown); margin:0 0 10px 0;">Confirm Action</h3>
        <p id="modalBody" style="font-size:13px; color:#777; line-height:1.5; margin-bottom:25px;"></p>
        
        <input type="hidden" id="modalActionType">

        <div style="display:flex; gap:12px;">
          <button onclick="closeModal()" style="background:#eee; color:#333; flex:1; border:none; padding:10px; border-radius:8px; cursor:pointer;">Cancel</button>
          <button id="modalConfirmBtn" onclick="executeModalAction()" style="color:white; flex:1; border:none; padding:10px; border-radius:8px; cursor:pointer;">Confirm</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    let html5QrCode;
    let fullInventoryData = [];

    const subCategoryMap = {
      "dhanyam": ["Rice", "Millets", "Dals", "Pulses", "Cereals", "Flours", "Oil Seeds", "Spices & Herbs", "Sweetners", "Dry Fruits", "Salts", "Oils & Ghee"],
      "gavya": ["Dhoop"],
      "soaps": ["Soaps"],
      "varnam": ["Ecofriendly Products"],
      "vastram": ["Vastram"]
    };

    function handleInventoryDelete() {
      const itemName = document.getElementsByName('itemName')[0].value || "this item";
      const sheet = document.getElementById('mainCategory').value;
      
      document.getElementById('modalTitle').innerText = "Delete Product?";
      document.getElementById('modalBody').innerHTML = `Are you sure you want to PERMANENTLY delete <b>${itemName}</b> from <b>${sheet}</b>? This cannot be undone.`;
      document.getElementById('modalIcon').innerText = "‚ö†Ô∏è";
      document.getElementById('modalActionType').value = "INVENTORY";
      
      const confirmBtn = document.getElementById('modalConfirmBtn');
      confirmBtn.innerText = "Delete Forever";
      confirmBtn.style.background = "var(--danger-red)"; // Danger color
      
      document.getElementById('customModal').style.display = 'flex';
    }

    function playBeep() {
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.1);
      } catch (e) { console.log("Audio not supported"); }
    }

    function updateSubCategories(selectedSub) {
      const main = document.getElementById('mainCategory').value;
      const subSelect = document.getElementById('subCategory');
      subSelect.innerHTML = "";
      
      if (subCategoryMap[main]) {
        subCategoryMap[main].forEach(opt => {
          let el = document.createElement("option");
          el.value = opt; el.textContent = opt;
          subSelect.appendChild(el);
        });
        if (selectedSub) subSelect.value = selectedSub;
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById('recentItemsBody');
      tbody.innerHTML = '';

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No items found</td></tr>';
        return;
      }

      data.forEach(item => {
        const row = tbody.insertRow();
        const isLow = item.stock <= item.reorder;
        if (isLow) row.classList.add('low-stock-row');

        row.onclick = () => {
          if (item.sheetOrigin) {
            document.getElementById('mainCategory').value = item.sheetOrigin;
            updateSubCategories();
          }
          document.getElementById('searchInput').value = item.sku || item.slNo;
          findItem();
        };

        // --- Logic for Image Tick Mark ---
        // Check if image_url exists and is not an empty string
        const hasImage = item.image_url && item.image_url.trim() !== "";
        const imageStatus = hasImage ? '<span style="color:var(--success-green); font-weight:bold;">‚úî</span>' : '<span style="color:#ccc;">-</span>';

        // Formatting Date
        let dateTimeDisplay = "--";
        if (item.updated) {
          const d = new Date(item.updated);
          if (!isNaN(d)) {
            const datePart = d.toLocaleDateString([], { day: '2-digit', month: '2-digit' });
            const timePart = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            dateTimeDisplay = `${datePart}, ${timePart}`;
          }
        }

        row.innerHTML = `
          <td style="color:var(--vg-brown); font-weight:bold;">${item.slNo || item.id}</td>
          <td>${item.name}${isLow ? '<span class="warning-icon"> ‚ö†Ô∏è</span>' : ''}</td>
          <td style="text-align:center;">${imageStatus}</td> <td>${item.sku || '-'}</td>
          <td style="font-weight:bold; color:${isLow ? 'var(--danger-red)' : 'inherit'}">${item.stock}</td>
          <td style="color:#666; font-size:9px; white-space: nowrap;">${dateTimeDisplay}</td>
        `;
      });
    }

    function loadRecentItems() {
      const sheetName = document.getElementById('mainCategory').value;
      google.script.run.withSuccessHandler(items => {
        fullInventoryData = items;
        renderTable(items);
      }).getRecentItems(sheetName);
    }

    function filterSidebarList() {
      const val = document.getElementById('listFilter').value.toLowerCase();
      const filtered = fullInventoryData.filter(i => 
        i.name.toLowerCase().includes(val) || 
        (i.sku && i.sku.toLowerCase().includes(val))
      );
      renderTable(filtered);
    }

    function startScanner() {
      document.getElementById('scanner-wrapper').style.display = 'block';
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
        playBeep(); document.getElementById('searchInput').value = txt;
        stopScanner(); findItem();
      }, () => {});
    }

    function stopScanner() {
      if (html5QrCode) { html5QrCode.stop().then(() => { document.getElementById('scanner-wrapper').style.display = 'none'; }); }
    }

    function findItem() {
        const term = document.getElementById('searchInput').value;
        if (!term) return;
        const searchBtn = document.getElementById('mainSearchBtn');
        searchBtn.innerHTML = "Searching...";
        searchBtn.disabled = true;

        google.script.run.withSuccessHandler(res => {
            searchBtn.innerHTML = "Search";
            searchBtn.disabled = false;
            
            if (res) {
                const d = res.data; 
                const f = document.getElementById('entryForm');
                
                // Extract meaningful data for the message
                const itemName = d[2];
                const currentStock = d[4];
                const reorderPoint = d[9];
                const category = res.sheetName;

                // Fill the form fields
                document.getElementById('rowNumber').value = res.row;
                document.getElementById('slNo').value = d[0];
                f.mainCategory.value = category;
                updateSubCategories(d[1]);
                
                f.itemName.value = itemName; 
                f.uom.value = d[3];
                f.stock.value = currentStock; 
                f.purchasePrice.value = d[5]; 
                f.priceMarkupPercentage.value = d[6];
                f.salePrice.value = d[7]; 
                f.stockValue.value = d[8]; 
                f.reorderPoint.value = reorderPoint;
                f.moq.value = d[10]; 
                f.vendorID.value = d[11]; 
                f.status.value = d[12];
                f.mfgDate.value = d[13]; 
                f.expiryDate.value = d[14]; 
                f.sku.value = d[15];
                
                // Image loading logic
                f.image_url.value = d[16] || "";
                f.delete_url.value = d[17] || "";
                if (d[16]) {
                    document.getElementById('imgPreview').src = d[16];
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                    document.getElementById('deleteBtn').style.display = 'block';
                } else {
                    document.getElementById('imagePreviewContainer').style.display = 'none';
                    document.getElementById('deleteBtn').style.display = 'none';
                }

                // Update UI Button
                document.getElementById('submitBtn').innerHTML = `Update ${itemName}`;
                document.getElementById('submitBtn').style.backgroundColor = "var(--success-green)";
                
                // --- Intuitive Success Message ---
                let statusMsg = `‚úÖ Found: ${itemName} in ${category}`;
                let statusColor = "var(--success-green)";

                // Add stock warning to the message if necessary
                if (Number(currentStock) <= Number(reorderPoint)) {
                    statusMsg = `‚ö†Ô∏è Found: ${itemName} (Low Stock: ${currentStock})`;
                    statusColor = "var(--vg-amber)"; // Use amber/orange for warning
                }

                document.getElementById('deleteInventoryBtn').style.display = 'block';
                showStatus(statusMsg, statusColor);

            } else {
                showStatus(`‚ùå No item found matching "${term}"`, "#dc3545");
                clearFormToDefault(false);
            }
        }).searchItem(term);
    }

    function clearImageWarning() {
      const fileInput = document.getElementById('imageFileSelector');
      // Remove the red border as soon as the user selects a file
      fileInput.style.border = "1px solid var(--border-light)";
      fileInput.style.outline = "none";
    }


    async function uploadToImgBB() {
      const fileInput = document.getElementById('imageFileSelector');
      const sku = document.getElementById('skuField').value;
      const sheetName = document.getElementById('mainCategory').value; // Get folder name
      const itemName = document.getElementsByName('itemName')[0].value;
      const btn = document.getElementById('uploadBtn');
      
      // VALIDATION: Check if file is selected
      if (!fileInput.files || fileInput.files.length === 0) {
        showStatus("‚ùå Please select a product image first!", "#dc3545");
        fileInput.style.outline = "2px solid red";
        return;
      }
      
      if (!sku) {
        showStatus("‚ùå SKU is required for naming the image!", "#dc3545");
        return;
      }

      clearImageWarning();

      fileInput.style.outline = "none";
      btn.innerHTML = "Uploading...";
      
      // Create an organized filename: e.g., "dhanyam_VG-RICE-123.png"
      const organizedName = `${sheetName.toUpperCase()}_${sku}`;

      const formData = new FormData();
      formData.append("image", fileInput.files[0]);
      formData.append("name", organizedName); // This organizes it in your ImgBB dashboard

      try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=f54eb6c9064b8717c21c9d293fa04e2d`, { 
          method: "POST", 
          body: formData 
        });
        const result = await response.json();
        
        if (result.success) {
          document.getElementById('image_url_hidden').value = result.data.url;
          document.getElementById('delete_url_hidden').value = result.data.delete_url;
          document.getElementById('imgPreview').src = result.data.url;
          document.getElementById('imagePreviewContainer').style.display = 'block';
          document.getElementById('deleteBtn').style.display = 'block';
          showStatus(`Image stored in virtual folder: ${sheetName}`, "var(--success-green)");
        }
      } catch (e) { 
        showStatus("Upload Error", "#dc3545"); 
      }
      btn.innerHTML = "Upload";
    }

    // 1. TRIGGER FOR IMAGE REMOVAL
    function handleImageDeletion() {
      const itemName = document.getElementsByName('itemName')[0].value || "this item";
      
      document.getElementById('modalTitle').innerText = "Remove Image?";
      document.getElementById('modalBody').innerHTML = `This will unlink the photo from <b>${itemName}</b>. <br><small>Click Update afterward to save changes.</small>`;
      document.getElementById('modalIcon').innerText = "üñºÔ∏è";
      document.getElementById('modalActionType').value = "IMAGE";
      
      const confirmBtn = document.getElementById('modalConfirmBtn');
      confirmBtn.innerText = "Remove";
      confirmBtn.style.background = "var(--vg-amber)"; // Warning color
      
      document.getElementById('customModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('customModal').style.display = 'none';
    }

    // THE "YES" BUTTON HANDLER
    function executeModalAction() {
      const mode = document.getElementById('modalActionType').value;
      closeModal();

      if (mode === "IMAGE") {
        // Process Image Removal (UI only until 'Update' is clicked)
        document.getElementById('image_url_hidden').value = "";
        document.getElementById('delete_url_hidden').value = "";
        document.getElementById('imgPreview').src = "";
        document.getElementById('imagePreviewContainer').style.display = 'none';
        document.getElementById('deleteBtn').style.display = 'none';
        showStatus("Image unlinked. Click Update to save.", "var(--vg-amber)");
        
      } else if (mode === "INVENTORY") {
        // Process Full Row Deletion (Actually hits the Spreadsheet)
        const itemName = document.getElementsByName('itemName')[0].value;
        const row = document.getElementById('rowNumber').value;
        const sheet = document.getElementById('mainCategory').value;
        const delBtn = document.getElementById('deleteInventoryBtn');

        if (!row) return showStatus("Error: No item selected to delete", "red");

        // UI Feedback: Show user something is happening
        delBtn.disabled = true;
        delBtn.innerHTML = "Deleting...";

        google.script.run
          .withSuccessHandler(res => {
            // RESET SCREEN AFTER SUCCESS
            showStatus(`üóëÔ∏è ${itemName}: ${res}`, "var(--danger-red)");
            clearFormToDefault(true); // Resets form and search input
            loadRecentItems();        // Refreshes sidebar list
            delBtn.disabled = false;
            delBtn.innerHTML = "Delete Item";
          })
          .withFailureHandler(err => {
            showStatus("Error deleting: " + err, "red");
            delBtn.disabled = false;
            delBtn.innerHTML = "Delete Item";
          })
          .deleteItemRecord(sheet, row); // This must match your function in code.gs
      }
    }

    function confirmDelete() {
      // Clear the form data
      document.getElementById('image_url_hidden').value = "";
      document.getElementById('delete_url_hidden').value = "";
      
      // Update UI
      document.getElementById('imagePreviewContainer').style.display = 'none';
      document.getElementById('deleteBtn').style.display = 'none';
      document.getElementById('imgPreview').src = "";
      document.getElementById('imageFileSelector').value = "";
      
      closeModal();
      showStatus("Image unlinked. Click 'Update' to finalize changes.", "var(--vg-amber)");
    }

    function calculateAutoFields() {
      const p = parseFloat(document.getElementById('pPrice').value) || 0;
      const m = parseFloat(document.getElementById('markup').value) || 0;
      const s = parseFloat(document.getElementById('stockInput').value) || 0;
      document.getElementById('sPrice').value = (p * (1 + m/100)).toFixed(2);
      document.getElementById('valOutput').value = (p * s).toFixed(2);
    }

    function showStatus(msg, color) {
      const s = document.getElementById('status-bar');
      s.innerHTML = msg; 
      s.style.color = color; 
      s.style.display = 'block';
      // 5 seconds gives more time to read the item name
      setTimeout(() => { s.style.display = 'none'; }, 5000); 
    }

    document.getElementById('entryForm').addEventListener('submit', function (e) {
      e.preventDefault();

      // 1. Mandatory Vendor Check
      const vendorSelect = document.getElementById('vendorSelect');
      const itemName = document.getElementsByName('itemName')[0].value;
      
      if (!vendorSelect.value) {
        showStatus("‚ö†Ô∏è Please select a Vendor before saving!", "#dc3545");
        vendorSelect.style.borderColor = "red";
        vendorSelect.focus();
        return; // Stop the submission
      } else {
        vendorSelect.style.borderColor = "var(--border-light)";
      }

      const subBtn = document.getElementById('submitBtn');
      const isUpdate = subBtn.innerHTML.includes("Update");
      
      subBtn.disabled = true;

      // Function to handle shared success logic for both Add and Update
      const onSuccess = () => {
        // BUG FIX 1: Refresh the inventory list so the Tick Mark (‚úî) appears
        loadRecentItems(currentSheet);
        
        // BUG FIX 2: Clear any lingering red warning from the image upload
        if (imageInput) {
          imageInput.style.outline = "none";
          imageInput.style.borderColor = "var(--border-light)";
        }
      };

      if (!isUpdate) {
        // FLOW FOR NEW ITEMS
        subBtn.innerHTML = `Saving Barcode for ${itemName}...`;
        const sku = document.getElementById('skuField').value;

        google.script.run
          .withSuccessHandler(() => {
            subBtn.innerHTML = `Adding ${itemName} to Inventory...`;
            // Pass itemName to the next step
            submitFormData(this, itemName);
          })
          .withFailureHandler((err) => {
            showStatus(`Failed to save barcode for ${itemName}: ` + err.message, "#dc3545");
            subBtn.disabled = false;
            subBtn.innerHTML = "Add to Inventory";
          })
          .saveBarcodeToDrive(sku, itemName);
      } else {
        // FLOW FOR UPDATES
        subBtn.innerHTML = `Updating ${itemName}...`;
        submitFormData(this, itemName);
      }
    });

    function submitFormData(formElement, itemName) {
      const subBtn = document.getElementById('submitBtn');
      google.script.run
        .withSuccessHandler((res) => {
          // res is the string "Added successfully!" or "Updated successfully!" from GS
          const fullMsg = `${itemName}: ${res}`; 
          showStatus(fullMsg, "var(--success-green)");
          
          clearFormToDefault(true);
          loadRecentItems();
          subBtn.disabled = false;
          subBtn.innerHTML = "Add to Inventory";
        })
        .withFailureHandler((err) => {
          showStatus(`Error processing ${itemName}: ` + err, "#dc3545");
          subBtn.disabled = false;
          subBtn.innerHTML = "Add to Inventory";
        })
        .processForm(formElement);
    }

    function clearFormToDefault(c) {
      const currentSheet = document.getElementById('mainCategory').value;
      document.getElementById('entryForm').reset();
      document.getElementById('mainCategory').value = currentSheet; // Preserve current sheet selection
      updateSubCategories(); 
      document.getElementById('submitBtn').innerHTML = "Add to Inventory";
      document.getElementById('submitBtn').style.backgroundColor = "var(--vg-brown)";
      if(c) document.getElementById('searchInput').value = "";
      document.getElementById('markup').value = "20";
      document.getElementById('imagePreviewContainer').style.display = 'none';
      document.getElementById('deleteBtn').style.display = 'none';
      document.getElementById('rowNumber').value = "";
      document.getElementById('slNo').value = "";
      document.getElementById('deleteInventoryBtn').style.display = 'none';

      const fileInput = document.getElementById('imageFileSelector');
      if (fileInput) {
        fileInput.style.outline = "none";
        fileInput.style.border = "1px solid var(--border-light)";
        fileInput.value = ""; // Clear the actual file selection
      }
    }

    function loadVendors() {
      google.script.run.withSuccessHandler(vendors => {
        const select = document.getElementById('vendorSelect');
        select.innerHTML = '<option value="">-- Select Vendor --</option>';
        vendors.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.id; opt.innerHTML = v.name; select.appendChild(opt);
        });
      }).getVendorList();
    }

    function autoGenerateSKU() {
      const mainCat = document.getElementById('mainCategory').value;
      const vendorId = document.getElementById('vendorSelect').value;
      if (!vendorId || document.getElementById('rowNumber').value) return; // Don't auto-gen if updating
      const catCode = mainCat.substring(0,3).toUpperCase();
      const cleanVnd = vendorId.substring(0,4).toUpperCase();
      const suffix = Math.floor(100 + Math.random() * 900);
      document.getElementById('skuField').value = `VG-${catCode}-${cleanVnd}-${suffix}`;
    }

     // Function to check for duplicates while typing/scanning
    function validateSkuLive() {
      const sku = document.getElementById('skuField').value;
      const currentSlNo = document.getElementById('slNo').value;
      if (!sku) return;

      google.script.run.withSuccessHandler(duplicate => {
        if (duplicate) {
          showStatus("‚ö†Ô∏è SKU used in " + duplicate.sheet, "#f44336");
          document.getElementById('skuField').style.borderColor = "red";
        } else {
          document.getElementById('skuField').style.borderColor = "var(--border-light)";
        }
      }).checkSkuExists(sku, currentSlNo);
    }

    function generateAndSaveBarcode() {
      const sku = document.getElementById('skuField').value;
      const itemName = document.getElementsByName('itemName')[0].value;
      const btn = document.getElementById('saveBarcodeBtn');

      if (!sku || !itemName) return showStatus("Need SKU and Item Name!", "#dc3545");

      btn.innerHTML = "Saving...";
      btn.disabled = true;

      google.script.run
        .withSuccessHandler(url => {
          showStatus("Barcode saved to Drive!", "var(--success-green)");
          btn.innerHTML = "Save Barcode";
          btn.disabled = false;
          // Optional: Open the image in a new tab
          window.open(url, '_blank');
        })
        .withFailureHandler(err => {
          showStatus(err.message, "#dc3545");
          btn.disabled = false;
        })
        .saveBarcodeToDrive(sku, itemName);
    }

    function handleSearchKeyPress(e) { if (e.keyCode === 13) { e.preventDefault(); findItem(); } }
    window.onload = function () { updateSubCategories(); loadRecentItems(); loadVendors(); };
  </script>
</body>

</html>