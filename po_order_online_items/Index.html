<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root { --p-purple: #673ab7; }
    body { background: #f8f9fa; font-size: 14px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .nav-tabs .nav-link.active { color: var(--p-purple); font-weight: bold; border-bottom: 3px solid var(--p-purple); }
    .sidebar { background: white; height: calc(100vh - 60px); border-right: 1px solid #dee2e6; padding: 20px; overflow-y: auto; }
    .main-content { padding: 25px; height: calc(100vh - 60px); overflow-y: auto; }
    .vendor-card { border-left: 4px solid var(--p-purple); margin-bottom: 12px; cursor: pointer; transition: transform 0.1s; }
    .vendor-card:hover { transform: translateX(5px); background: #f3e5f5; }
    .status-badge { font-size: 11px; padding: 5px 10px; border-radius: 20px; font-weight: 600; text-transform: uppercase; }
    .status-ordered { background: #e9ecef; color: #495057; }
    #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:10000; justify-content:center; align-items:center; }
  </style>
</head>
<body>

<div id="overlay"><div class="spinner-border text-primary" role="status"></div></div>

<ul class="nav nav-tabs bg-white px-3 pt-2 sticky-top shadow-sm">
  <li class="nav-item"><a class="nav-link active" id="btn-create" href="#" onclick="showTab('create')">Create Purchase Order</a></li>
  <li class="nav-item"><a class="nav-link" id="btn-history" href="#" onclick="showTab('history')">Order History</a></li>
</ul>

<div id="tab-create" class="container-fluid">
  <div class="row">
    <div class="col-md-3 sidebar">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="text-uppercase fw-bold text-muted">Vendors</h6>
        <button class="btn btn-sm btn-link p-0" onclick="refreshData()">Sync üîÑ</button>
      </div>
      <input type="text" id="vendorSearch" class="form-control form-control-sm mb-3" placeholder="Filter vendors..." onkeyup="filterVendors()">
      <div id="vendor-list"></div>
      
      <h6 class="text-uppercase fw-bold text-muted mt-4">Stock Alerts</h6>
      <div id="stock-alerts" class="small"></div>
    </div>

    <div class="col-md-9 main-content">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">PO Builder</h4>
            <div class="text-end">
              <small class="text-muted d-block">Reference Number</small>
              <span class="badge bg-dark fs-6" id="po-num-display"></span>
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-5">
              <label class="form-label fw-bold small">Vendor Name</label>
              <input type="text" id="po-vendor-name" class="form-control bg-light" placeholder="Select a vendor from sidebar" readonly>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold small">Priority</label>
              <select id="po-priority" class="form-select">
                <option value="Normal">Normal</option>
                <option value="Urgent">Urgent</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold small">Requested Arrival</label>
              <input type="date" id="po-arrive" class="form-control">
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Item Description</th>
                  <th>SKU</th>
                  <th width="100">Qty</th>
                  <th>Unit Price</th>
                  <th>Subtotal</th>
                  <th width="50"></th>
                </tr>
              </thead>
              <tbody id="po-lines"></tbody>
            </table>
          </div>

          <div class="d-flex justify-content-between align-items-end mt-4">
            <div class="text-muted small">Items are automatically fetched based on vendor selection.</div>
            <div class="text-end">
              <h2 class="mb-3">Total: ‚Çπ<span id="grand-total">0.00</span></h2>
              <button class="btn btn-primary btn-lg px-5 shadow" onclick="submitPO()">Finalize & Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="tab-history" class="container-fluid d-none p-4">
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>Order History</h4>
        <input type="text" class="form-control w-25" placeholder="Search POs..." onkeyup="filterHistory(this.value)">
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>PO Number</th>
              <th>Vendor ID</th>
              <th>Grand Total</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="successModal" data-bs-backdrop="static" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg p-4">
      <div class="modal-body text-center">
        <div class="display-1 text-success mb-3">‚úÖ</div>
        <h3 class="fw-bold">Order Saved</h3>
        <p class="text-muted">The Purchase Order has been successfully inserted into the spreadsheet.</p>
        <div class="bg-light p-3 rounded mb-4">
          <span class="small text-uppercase text-muted d-block">PO Number</span>
          <h4 class="mb-0" id="saved-po-num"></h4>
        </div>
        <div class="d-grid gap-2">
          <button class="btn btn-primary py-2" onclick="printCurrentPO()">Print Purchase Order üñ®Ô∏è</button>
          <button class="btn btn-outline-secondary py-2" onclick="resetUI()">Create New Order</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let allVendors = [], allAlerts = [], cart = [], selectedVendor = null, lastHeader = null;

  window.onload = () => { generatePONumber(); refreshData(); };

  function showTab(t) {
    document.getElementById('tab-create').classList.toggle('d-none', t !== 'create');
    document.getElementById('tab-history').classList.toggle('d-none', t !== 'history');
    document.getElementById('btn-create').classList.toggle('active', t === 'create');
    document.getElementById('btn-history').classList.toggle('active', t === 'history');
    if(t === 'history') loadHistory();
  }

  function generatePONumber() { document.getElementById('po-num-display').innerText = "PO-" + Math.floor(Date.now()/1000); }

  function refreshData() {
    google.script.run.withSuccessHandler(v => { allVendors = v; renderVendors(v); }).getVendors();
    google.script.run.withSuccessHandler(a => { allAlerts = a; }).getStockAlerts();
  }

  function renderVendors(list) {
    document.getElementById('vendor-list').innerHTML = list.map(v => `
      <div class="card vendor-card p-2 shadow-sm" onclick="selectVendor('${v.vendorID}')">
        <div class="fw-bold">${v.businessName}</div>
        <div class="text-muted extra-small" style="font-size:11px">ID: ${v.vendorID}</div>
      </div>`).join('');
  }

  function selectVendor(id) {
    selectedVendor = allVendors.find(v => v.vendorID === id);
    document.getElementById('po-vendor-name').value = selectedVendor.businessName;
    const vendorAlerts = allAlerts.filter(a => String(a.vendorID) === id);
    document.getElementById('stock-alerts').innerHTML = vendorAlerts.map((a, i) => `
      <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-white">
        <span>${a.itemName}</span>
        <button class="btn btn-sm btn-outline-primary" onclick='addToCartByIdx(${allAlerts.indexOf(a)})'>Add</button>
      </div>`).join('') || '<div class="text-muted small">No items low on stock for this vendor.</div>';
  }

  function addToCartByIdx(idx) {
    const item = allAlerts[idx];
    if(!cart.find(c => c.itemId === item.itemId)) {
      cart.push({...item, quantity: item.moq, subtotal: item.moq * item.unitPrice});
      renderCart();
    }
  }

  function renderCart() {
    let total = 0;
    document.getElementById('po-lines').innerHTML = cart.map((item, idx) => {
      total += item.subtotal;
      return `<tr>
        <td>${item.itemName}</td>
        <td><small class="text-muted">${item.sku}</small></td>
        <td><input type="number" class="form-control form-control-sm" value="${item.quantity}" onchange="updateQty(${idx}, this.value)"></td>
        <td>‚Çπ${item.unitPrice}</td>
        <td class="fw-bold">‚Çπ${item.subtotal.toFixed(2)}</td>
        <td><button class="btn btn-sm text-danger" onclick="cart.splice(${idx},1);renderCart()">√ó</button></td>
      </tr>`;
    }).join('');
    document.getElementById('grand-total').innerText = total.toLocaleString('en-IN', {minimumFractionDigits: 2});
  }

  function updateQty(idx, val) { 
    cart[idx].quantity = val; 
    cart[idx].subtotal = val * cart[idx].unitPrice; 
    renderCart(); 
  }

  function submitPO() {
    if(!selectedVendor || !cart.length) return alert("Please select a vendor and add at least one item.");
    document.getElementById('overlay').style.display = 'flex';
    const header = { 
      poNumber: document.getElementById('po-num-display').innerText, 
      priority: document.getElementById('po-priority').value, 
      vendorID: selectedVendor.vendorID, 
      arriveBy: document.getElementById('po-arrive').value, 
      cost: document.getElementById('grand-total').innerText, 
      poc: selectedVendor.poc, 
      notes: "Auto-generated" 
    };
    lastHeader = header;
    google.script.run.withSuccessHandler(res => {
      document.getElementById('overlay').style.display = 'none';
      if(res.success) {
        document.getElementById('saved-po-num').innerText = header.poNumber;
        new bootstrap.Modal(document.getElementById('successModal')).show();
      } else { alert("Error: " + res.error); }
    }).finalizePurchaseOrder(header, cart);
  }

  function loadHistory() {
    google.script.run.withSuccessHandler(data => {
      document.getElementById('history-body').innerHTML = data.map(po => `
        <tr>
          <td>${po.date}</td>
          <td><strong>${po.poNumber}</strong></td>
          <td>${po.vendorID}</td>
          <td>‚Çπ${po.cost}</td>
          <td><span class="status-badge status-ordered">${po.status}</span></td>
          <td><button class="btn btn-sm btn-outline-dark" onclick="reprintPO('${po.poNumber}')">Print</button></td>
        </tr>`).join('');
    }).getPOHistory();
  }

  function printCurrentPO() {
    google.script.run.withSuccessHandler(html => { 
      const w = window.open(); 
      w.document.write(html); 
      w.document.close(); 
      setTimeout(() => w.print(), 500); 
    }).generatePOPreview(lastHeader, cart);
  }

  function resetUI() { location.reload(); }
</script>
</body>
</html>